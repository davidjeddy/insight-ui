<!doctype html>
<html>
<head>
    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>


    <!-- circle master -->
    <script src="js/circles-master/circles.js"></script>


    <!-- moment js -->
    <script type="text/javascript" src="js/moment/moment.js"></script>

    <!-- datetime picker -->
    <script type="text/javascript" src="js/bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>

    <!-- data tables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.css">
    <script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>

    <!-- jq plot -->
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>




    <script>
        function getCircleColors(percent) {
            var colors;

            if (percent > 75) {
                // green
                colors = ['#a9ef97', '#51ef26'];
            } else if (percent > 55) {
                // orange
                colors = ['#efc586', '#ed981a'];
            } else {
                // red
                colors = ['#eda1a1', '#ed1e1e'];
            }

            return colors;
        }

        var renewalCircle;
        var cumRenewalCircle;
        $(function () {


            renewalCircle = Circles.create({
                id: 'renewal-circle',
                radius: 60,
                value: 0,
                maxValue: 100,
                width: 10,
                text: function (value) {
                    return value + '%';
                },
                colors: ['#D3D3D3', '#D3D3D3'],
                duration: 400,
                wrpClass: 'circles-wrp',
                textClass: 'circles-text',
                valueStrokeClass: 'circles-valueStroke',
                maxValueStrokeClass: 'circles-maxValueStroke',
                styleWrapper: true,
                styleText: true
            });

            cumRenewalCircle = Circles.create({
                id: 'cum-renewal-circle',
                radius: 60,
                value: 0,
                maxValue: 100,
                width: 10,
                text: function (value) {
                    return value + '%';
                },
                colors: ['#D3D3D3', '#D3D3D3'],
                duration: 400,
                wrpClass: 'circles-wrp',
                textClass: 'circles-text',
                valueStrokeClass: 'circles-valueStroke',
                maxValueStrokeClass: 'circles-maxValueStroke',
                styleWrapper: true,
                styleText: true
            });


            $('#report-start-date').datetimepicker({format: 'MM/DD/YYYY', daysOfWeekDisabled: [1, 2, 3, 4, 5, 6]});
            $('#customer-start-date').datetimepicker({format: 'MM/DD/YYYY', daysOfWeekDisabled: [1, 2, 3, 4, 5, 6]});
            // clear date pickers on page load
            $('#report-date').val('');
            $('#customer-group').val('');

            //todo: figure out a way here to highlight days the user can select in the menu
            $(document).on('dp.show', function(e) {
                console.log('show');
                var x = $('[data-action="selectDay"]').css({ 'color': 'red', 'font-size': '150%' });
                console.log(x);
            });

//            var dataSet = [
//                [ "Tiger Nixon", "System Architect", "Edinburgh", "5421", "2011/04/25", "$320,800" ],
//                [ "Garrett Winters", "Accountant", "Tokyo", "8422", "2011/07/25", "$170,750" ],
//                [ "Ashton Cox", "Junior Technical Author", "San Francisco", "1562", "2009/01/12", "$86,000" ],
//                [ "Cedric Kelly", "Senior Javascript Developer", "Edinburgh", "6224", "2012/03/29", "$433,060" ],
//            ];

            getStores();

            $('#store-dropdown').on('change', function() {
                getDashboardData();
            });

            $(document).on('dp.change', function(e) {
                getDashboardData();
            });



        });

        /**
         * Gets a list of stores for drop down
         */
        function getStores() {

            $.ajax({
                url: 'http://34.230.19.251:8080/api/v1/store/index',
                type: 'get',
                success: function(data) {
                    data.items.forEach(function(element, index) {
                        var option = '<option value="' + element.id + '">' + element.name + '</option>';
                        $("#store-dropdown").append(option);
                    });
                },
                error: function() {
                    alert('error');
                }
            })
        }

        function getQueryParams() {
            var reportStart = $('#report-date').val();
            var custGroup = $('#customer-group').val();
            var store =$('#store-dropdown').val();

            return queryParams = $.param([
                {name: 'store_id', value: store},
                {name: 'customer_group', value: custGroup},
                {name: 'report_date', value: reportStart}
            ]);
        }

        function areDatesValid() {
            var reportStart = $('#report-date').val();
            var custGroup = $('#customer-group').val();
            var areDatesValid = true;

            if (reportStart !==  '' && custGroup !== '') {
                reportStart = Date.parse(reportStart);
                custGroup = Date.parse(custGroup);

                if (reportStart < custGroup) {
                    areDatesValid = false;
                }
            }

            return areDatesValid;
        }


        var dashboardData;
        function getDashboardData() {
            if (!areDatesValid()) {
                $('#invalid-date-alert').show();
                console.log('dates are invalid');
                return;
            } else {
                $('#invalid-date-alert').hide();
            }

            var queryParams = getQueryParams();

            $.ajax({
                url: 'http://34.230.19.251:8080/api/v1/dashboard/index?' + queryParams,
                type: 'get',
                success: function(data) {
                    dashboardData = data;

                    // setup new customer tab
                    initNewCustomerDataTable(dashboardData.new_customers);

                    // setup lost customer tab
                    initLostCustomerDataTable(dashboardData.lost_customers);

                    updateRevenue(dashboardData.revenue);

                    updateOrders(dashboardData.order_count);

                    updateAov(dashboardData.aov);

                    updateRenewal(dashboardData.renewal);

                    updateCummulativeRenewal(dashboardData.cumulative_renewal);

                    console.log('success callback');

                    $('#customer-tabs-panel').show();
                },
                error: function() {
                    console.log('error callback');
                }
            });
        }

        function updateCummulativeRenewal(cumRenewal) {
            cumRenewalCircle.update(cumRenewal);
            cumRenewalCircle.updateColors(getCircleColors(cumRenewal));
        }

        function updateRenewal(renewal) {
            renewalCircle.update(renewal);
            renewalCircle.updateColors(getCircleColors(renewal));
        }

        function updateRevenue(revenue) {
            $('#revenue').html('$' + revenue);
        }

        function updateOrders(orders) {
            $('#orders').html(orders);
        }

        function updateAov(aov) {
            $('#aov').html('$' + aov);
        }

        var newCustDataTable;
        function initNewCustomerDataTable(newCustomers) {
            /**
             * {
                  "customer_id": "455",
                  "username": "dkirschweng",
                  "total_order_amt": "129.4200",
                  "store_id": "3",
                  "store_name": "Countryside"
                },
             */

            if (!$.fn.dataTable.isDataTable('#new-customer-tab')) {
                newCustDataTable = $('#new-customer-tab').DataTable( {
                    data: newCustomers,
                    searching: false,
                    lengthChange: false,
                    columns: [
                        { title: "Customer",  data: "username"},
                        { title: "Role", data: "role"},
                        { title: "Total Order Amount", data: "total_order_amt" },
                        { title: "Store", data: "store_name" }
                    ]
                });
            } else {
                newCustDataTable.clear();
                newCustDataTable.rows.add(newCustomers);
                newCustDataTable.draw();
            }
        }

        var lostCustTable;
        function initLostCustomerDataTable(lostCustomers) {
            /**
             * {
                  "id": "198",
                  "role": "Subscriber",
                  "username": "karilynn0216",
                  "customer_id": "198",
                  "lifetime_amt": "320.8500",
                  "avg_order_amt": "106.95000000"
                }
             */
            if (!$.fn.dataTable.isDataTable('#lost-customer-tab')) {

                lostCustTable = $('#lost-customer-tab').DataTable({
                    data: lostCustomers,
                    searching: false,
                    lengthChange: false,
                    columns : [
                        {title: "Customer", data: "username"},
                        {title: "Role", data: "role"},
                        {title: "Average Order Amount", data: "avg_order_amt"},
                        {title: "Lifetime Order Amount", data: "lifetime_amt"}
                    ]
                });
            } else {
                lostCustTable.clear();
                lostCustTable.rows.add(lostCustomers);
                lostCustTable.draw();
            }

        }

        getDashboardData();

    </script>
    <style>
        .top-column {
            font-size:50px;
        }

        #report-container {
            margin-top:15px;
        }

        #renewal-rate-container {
            margin-top:15px;
        }

        #column2-row2 {
            margin-top:75px;
            font-size:20px;
        }

        .circle-label {
            margin-top:15px;
        }
    </style>


    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta http-equiv="Content-Language" content="en">

</head>
<body>


<div class="container-fluid">

    <div id="invalid-date-alert" class="alert alert-danger" role="alert" style="display:none;">
        Report date must be after the customer group date.
    </div>

    <div class="panel panel-default">
        <div id="top-panel" class="panel-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Report Start Date</label>
                        <div class='input-group date' id='report-start-date'>
                            <input id="report-date" type='text' class="form-control" value="''"/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <label>Store</label>

                    <select id="store-dropdown" class="form-control">
                        <option value="">All Stores</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label>Customer Start Date</label>
                    <div class="form-group">
                        <div class='input-group date' id='customer-start-date'>
                            <input id="customer-group" type='text' class="form-control"/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="report-container" class="row">
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <div class="top-column">
                                <label>Orders:</label> <span id="orders">0</span>
                            </div>
                        </div>
                    </div>
                    <div id="renewal-rate-container" class="row">
                        <div class="col-md-6 text-center">
                            <div class="circle" id="renewal-circle"></div>
                            <label class="circle-label">Renewal Rate</label>
                        </div>
                        <div class="col-md-6 text-center">
                            <div class="circle" id="cum-renewal-circle"></div>
                            <label class="circle-label">Cumulative Renewal Rate</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <div class="top-column">
                                <label>Revenue:</label> <span id="revenue">$0.00</span>
                            </div>
                        </div>
                    </div>
                    <div id="column2-row2" class="row">
                        <div class="col-md-12 text-center">
                            <label>Average Order Value:</label> <span id="aov">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="dashboard-top-spinner" class="overlay">
            <i class="fa fa-refresh fa-spin"></i>
        </div>
    </div>




    <div id="customer-tabs-panel" class="panel panel-default" style="display:none;">
        <div class="panel-body">
            <div>
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">New Customers</a></li>
                    <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Lost Customers</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="home">
                        <table class="table" id="new-customer-tab" style="width:100%"></table>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="profile">
                        <table class="table" id="lost-customer-tab" style="width:100%"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>




</div>


</body>
</html>