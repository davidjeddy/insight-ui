<!doctype html>
<html>
<head>
    <title>
        Insight - Dashboard
    </title>
    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>


    <!-- circle master -->
    <script src="js/circles-master/circles.js"></script>


    <!-- moment js -->
    <script type="text/javascript" src="js/moment/moment.js"></script>

    <!-- datetime picker -->
    <script type="text/javascript" src="js/bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>

    <!-- data tables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.css">
    <script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>

    <!-- jq plot -->
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<style>
    /* Always set the map height explicitly to define the size of the div
     * element that contains the map. */
    #map {
        height: 100%;
    }
    /* Optional: Makes the sample page fill the window. */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
     .main-header {
        height: 50px;
        margin: 0%;
        /* Permalink - use to edit and share this gradient: http://colorzilla.com/gradient-editor/#7d7e7d+0,595959+11,0e0e0e+53,1e2f30+88 */
background: rgb(125,126,125); /* Old browsers */
background: -moz-linear-gradient(top, rgba(125,126,125,1) 0%, rgba(89,89,89,1) 11%, rgba(14,14,14,1) 53%, rgba(30,47,48,1) 88%); /* FF3.6-15 */
background: -webkit-linear-gradient(top, rgba(125,126,125,1) 0%,rgba(89,89,89,1) 11%,rgba(14,14,14,1) 53%,rgba(30,47,48,1) 88%); /* Chrome10-25,Safari5.1-6 */
background: linear-gradient(to bottom, rgba(125,126,125,1) 0%,rgba(89,89,89,1) 11%,rgba(14,14,14,1) 53%,rgba(30,47,48,1) 88%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7d7e7d', endColorstr='#1e2f30',GradientType=0 ); /* IE6-9 */
        top:0;
        width:100%;
        z-index:100;

        }
    .line-box {
        height: 53px;
        margin: 0%;
        background-color:mediumturquoise ;
        top:0;
        width:100%;
        z-index:100;
    }
    .bannertxt {
        color:aqua; font-family: 'Open Sans Condensed', sans-serif; font-size: 28px; font-weight: 300; margin: 0 0 10; padding: 20px 10px; text-align: center; text-transform: uppercase;
    }

.table-title h3 {
   color: #fafafa;
   font-size: 20px;
   font-weight: 400;
   font-style:normal;
   font-family: "Roboto", helvetica, arial, sans-serif;
   text-shadow: -1px -1px 1px rgba(0, 0, 0, 0.1);
   text-transform:uppercase;
}


/*** Table Styles **/
.panel-body {

    top: 10%;
    left: 50%;
    align-content: center;
    text-align: center;
}
.paginate_button {
padding: 5px;
margin-right: 2px;
border: 1.5px solid #adebe8;
color: #666B85;
font-family: verdana;
font-weight: 200
}
.paginate_button_disabled {
border: 1px solid #F3F3F3;
color: #CCCCCC;
margin-right: 2px;
padding: 2px 5px;
border: 0;
}
.paginate_button:hover {
border:1px solid #adebe8;
color: #fff;
background-color: #5cd6d2;
}
.paginate_active {
padding: 2px 5px 2px 5px;
margin-right: 2px;
border: 1px solid #adebe8;
font-weight: bold;
background-color: #52bfea;
color: #FFF;
}
.table-fill {
  background: white;
  border-radius:3px;
  border-collapse: collapse;
  height: 200px;
  margin: auto;
  max-width: 600px;
  padding:5px;
  width: 100%;
  box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
  animation: float 5s infinite;
}

th {
  color: mediumturquoise;
  background:#1b1e24;
  border-bottom:4px solid #9ea7af;
  border-right: 1px solid #343a45;
  font-size:18px;
  font-weight: 100;
  padding:14px;
  text-align:left;
  font-family: verdana;
  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
  vertical-align:middle;
}

th:first-child {
  border-top-left-radius:3px;
}

th:last-child {
  border-top-right-radius:3px;
}

tr {
  border-top: 1px solid #C1C3D1;
  border-bottom: 1px solid #C1C3D1;
  color:#666B85;
  font-size:16px;
  font-weight:normal;
  height: 2;
  text-shadow: 0 1px 1px rgba(256, 256, 256, 0.1);
  text-align: center;
}

tr:hover td {
  border-top: 1px solid #22262e;
  border-bottom: 1px solid #22262e;
}

tr:first-child {
  border-top:none;
}

tr:last-child {
  border-bottom:none;
}

tr:nth-child(odd) td {
  background:#EBEBEB;
}


tr:last-child td:first-child {
  border-bottom-left-radius:3px;
}

tr:last-child td:last-child {
  border-bottom-right-radius:3px;
}

td {
  background:#FFFFFF;
  padding:15px;
  text-align:left;
  vertical-align:middle;
  font-weight:300;
  font-size:18px;
  text-shadow: -1px -1px 1px rgba(0, 0, 0, 0.1);
  border-right: 1px solid #C1C3D1;
}

td:last-child {
  border-right: 0px;
}

th.text-left {
  text-align: left;
}

th.text-center {
  text-align: center;
}

th.text-right {
  text-align: right;
}

td.text-left {
  text-align: left;
}

td.text-center {
  text-align: center;
}

td.text-right {
  text-align: right;
}

</style>



    <script>
        function getCircleColors(percent) {
            var colors;

            if (percent > 75) {
                // green
                colors = ['#a9ef97', '#51ef26'];
            } else if (percent > 55) {
                // orange
                colors = ['#efc586', '#ed981a'];
            } else {
                // red
                colors = ['#eda1a1', '#ed1e1e'];
            }

            return colors;
        }

        var renewalCircle;
        var cumRenewalCircle;
        $(function () {


            renewalCircle = Circles.create({
                id: 'renewal-circle',
                radius: 60,
                value: 0,
                maxValue: 100,
                width: 10,
                text: function (value) {
                    return value + '%';
                },
                colors: ['#D3D3D3', '#D3D3D3'],
                duration: 400,
                wrpClass: 'circles-wrp',
                textClass: 'circles-text',
                valueStrokeClass: 'circles-valueStroke',
                maxValueStrokeClass: 'circles-maxValueStroke',
                styleWrapper: true,
                styleText: true
            });

            cumRenewalCircle = Circles.create({
                id: 'cum-renewal-circle',
                radius: 60,
                value: 0,
                maxValue: 100,
                width: 10,
                text: function (value) {
                    return value + '%';
                },
                colors: ['#D3D3D3', '#D3D3D3'],
                duration: 400,
                wrpClass: 'circles-wrp',
                textClass: 'circles-text',
                valueStrokeClass: 'circles-valueStroke',
                maxValueStrokeClass: 'circles-maxValueStroke',
                styleWrapper: true,
                styleText: true
            });


            $('#report-start-date').datetimepicker({format: 'MM/DD/YYYY', daysOfWeekDisabled: [1, 2, 3, 4, 5, 6]});
            $('#customer-start-date').datetimepicker({format: 'MM/DD/YYYY', daysOfWeekDisabled: [1, 2, 3, 4, 5, 6]});
            // clear date pickers on page load
            $('#report-date').val('');
            $('#customer-group').val('');

            //todo: figure out a way here to highlight days the user can select in the menu
            $(document).on('dp.show', function(e) {
                console.log('show');
                var x = $('.datepicker tbody tr');
                x.each(function(index, element) {
                    $(element).find('td').first().css({'color': 'green', 'font-weight': 'bolder', 'text-decoration': 'underline'});
                });
                console.log(x);
            });

//            var dataSet = [
//                [ "Tiger Nixon", "System Architect", "Edinburgh", "5421", "2011/04/25", "$320,800" ],
//                [ "Garrett Winters", "Accountant", "Tokyo", "8422", "2011/07/25", "$170,750" ],
//                [ "Ashton Cox", "Junior Technical Author", "San Francisco", "1562", "2009/01/12", "$86,000" ],
//                [ "Cedric Kelly", "Senior Javascript Developer", "Edinburgh", "6224", "2012/03/29", "$433,060" ],
//            ];

            getStores();

            $('#store-dropdown').on('change', function() {
                getDashboardData();
            });

            $(document).on('dp.change', function(e) {
                getDashboardData();
            });



        });

        /**
         * Gets a list of stores for drop down
         */
        function getStores() {

            $.ajax({
                url: 'http://34.230.19.251:8080/api/v1/store/index',
                type: 'get',
                success: function(data) {
                    data.items.forEach(function(element, index) {
                        var option = '<option value="' + element.id + '">' + element.name + '</option>';
                        $("#store-dropdown").append(option);
                    });
                },
                error: function() {
                    alert('error');
                }
            })
        }

        function getQueryParams() {
            var reportStart = $('#report-date').val();
            var custGroup = $('#customer-group').val();
            var store =$('#store-dropdown').val();

            return queryParams = $.param([
                {name: 'store_id', value: store},
                {name: 'customer_group', value: custGroup},
                {name: 'report_date', value: reportStart}
            ]);
        }

        function areDatesValid() {
            var reportStart = $('#report-date').val();
            var custGroup = $('#customer-group').val();
            var areDatesValid = true;

            if (reportStart !==  '' && custGroup !== '') {
                reportStart = Date.parse(reportStart);
                custGroup = Date.parse(custGroup);

                if (reportStart < custGroup) {
                    areDatesValid = false;
                }
            }

            return areDatesValid;
        }


        var dashboardData;
        function getDashboardData() {
            if (!areDatesValid()) {
                $('#invalid-date-alert').show();
                console.log('dates are invalid');
                return;
            } else {
                $('#invalid-date-alert').hide();
            }

            var queryParams = getQueryParams();

            $.ajax({
                url: 'http://34.230.19.251:8080/api/v1/dashboard/index?' + queryParams,
                type: 'get',
                success: function(data) {
                    dashboardData = data;

                    // setup new customer tab
                    initNewCustomerDataTable(dashboardData.new_customers);

                    // setup lost customer tab
                    initLostCustomerDataTable(dashboardData.lost_customers);

                    updateRevenue(dashboardData.revenue);

                    updateOrders(dashboardData.order_count);

                    updateAov(dashboardData.aov);

                    updateRenewal(dashboardData.renewal);

                    updateCummulativeRenewal(dashboardData.cumulative_renewal);

                    console.log('success callback');

                    $('#customer-tabs-panel').show();
                },
                error: function() {
                    console.log('error callback');
                }
            });
        }

        function updateCummulativeRenewal(cumRenewal) {
            cumRenewalCircle.update(cumRenewal);
            cumRenewalCircle.updateColors(getCircleColors(cumRenewal));
        }

        function updateRenewal(renewal) {
            renewalCircle.update(renewal);
            renewalCircle.updateColors(getCircleColors(renewal));
        }

        function updateRevenue(revenue) {
            $('#revenue').html('$' + revenue);
        }

        function updateOrders(orders) {
            $('#orders').html(orders);
        }

        function updateAov(aov) {
            $('#aov').html('$' + aov);
        }

        var newCustDataTable;
        function initNewCustomerDataTable(newCustomers) {
            /**
             * {
                  "customer_id": "455",
                  "username": "dkirschweng",
                  "total_order_amt": "129.4200",
                  "store_id": "3",
                  "store_name": "Countryside"
                },
             */

            if (!$.fn.dataTable.isDataTable('#new-customer-tab')) {
                newCustDataTable = $('#new-customer-tab').DataTable( {
                    data: newCustomers,
                    searching: false,
                    lengthChange: false,
                    columns: [
                        { title: "Customer",  data: "username"},
                        { title: "Role", data: "role"},
                        { title: "Total Order Amount", data: "total_order_amt" },
                        { title: "Store", data: "store_name" }
                    ]
                });
            } else {
                newCustDataTable.clear();
                newCustDataTable.rows.add(newCustomers);
                newCustDataTable.draw();
            }
        }

        var lostCustTable;
        function initLostCustomerDataTable(lostCustomers) {
            /**
             * {
                  "id": "198",
                  "role": "Subscriber",
                  "username": "karilynn0216",
                  "customer_id": "198",
                  "lifetime_amt": "320.8500",
                  "avg_order_amt": "106.95000000"
                }
             */
            if (!$.fn.dataTable.isDataTable('#lost-customer-tab')) {

                lostCustTable = $('#lost-customer-tab').DataTable({
                    data: lostCustomers,
                    searching: false,
                    lengthChange: false,
                    columns : [
                        {title: "Customer", data: "username"},
                        {title: "Role", data: "role"},
                        {title: "Average Order Amount", data: "avg_order_amt"},
                        {title: "Lifetime Order Amount", data: "lifetime_amt"}
                    ]
                });
            } else {
                lostCustTable.clear();
                lostCustTable.rows.add(lostCustomers);
                lostCustTable.draw();
            }

        }

        getDashboardData();

    </script>
    <style>
        .top-column {
            font-size:50px;
        }

        #report-container {
            margin-top:15px;
        }

        #renewal-rate-container {
            margin-top:15px;
        }

        #column2-row2 {
            margin-top:75px;
            font-size:20px;
        }

        .circle-label {
            margin-top:15px;
        }
    </style>


    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta http-equiv="Content-Language" content="en">

</head>
<body>

<!-- header -->
<div class="line-box">
  <div class="main-header" style="margin-left: 1px">


                <div style="float: left; margin-top: 5px">
                    <font class="bannertxt" style="margin-top: 1px;">Insight</font>
                </div>

                <div style="float: right; height: 20px; padding-top: 10px; padding-right:10px;">

                <button type="button" class="btn btn-primary btn-sm" onClick="window.location.href='./stores.html'" style="background: mediumturquoise; color: #FFFFF; font-family: verdana;"><span class="glyphicon glyphicon-list-alt"></span> View Stores</button>

                 <button type="button" class="btn btn-primary btn-sm" onClick="window.location.href='./map.html'" style="background: mediumturquoise; color: #FFFFF; font-family: verdana;"><span class="glyphicon glyphicon-map-marker"></span> View Map</button>

                </div>
        </div>

</div>

<div class="container-fluid" style="margin-top: 20px;">

    <div id="invalid-date-alert" class="alert alert-danger" role="alert" style="display:none;">
        Report date must be after the customer group date.
    </div>

    <div class="panel panel-default">
        <div id="top-panel" class="panel-body">
            <div id="report-container" class="row">
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <div class="top-column">
                                <label>Orders:</label> <span id="orders">0</span>
                            </div>
                        </div>
                    </div>
                    <div id="renewal-rate-container" class="row">
                        <div class="col-md-6 text-center">
                            <div class="circle" id="renewal-circle"></div>
                            <label class="circle-label">Renewal Rate</label>
                        </div>
                        <div class="col-md-6 text-center">
                            <div class="circle" id="cum-renewal-circle"></div>
                            <label class="circle-label">Cumulative Renewal Rate</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <div class="top-column">
                                <label>Revenue:</label> <span id="revenue">$0.00</span>
                            </div>
                        </div>
                    </div>
                    <div id="column2-row2" class="row">
                        <div class="col-md-12 text-center">
                            <label>Average Order Value:</label> <span id="aov">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>


        </div>
        <div id="dashboard-top-spinner" class="overlay">
            <i class="fa fa-refresh fa-spin"></i>
        </div>
    </div>

    <div class="panel panel-default" style="border:none">
        <div id="top-panel" class="panel-body" style="background-color:  #1b1e24;   font-size:15px; font-weight: 100; padding:14px; text-align: left; color: mediumturquoise; border-radius:10px;   font: verdana;">

       <div class="row">

                <div class="col-md-4">
                    <label style="font-size:18px; font-weight: 100; font-family: verdana">Store</label>

                    <select id="store-dropdown" class="form-control">
                        <option value="">All Stores</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <div class="form-group">
                        <label style="font-size:18px; font-weight: 100; font-family: verdana">Report Start Date</label>
                        <div class='input-group date' id='report-start-date'>
                            <input id="report-date" type='text' class="form-control" value="''"/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <label style="font-size:18px; font-weight: 100; font-family: verdana">Customer Start Date</label>
                    <div class="form-group">
                        <div class='input-group date' id='customer-start-date'>
                            <input id="customer-group" type='text' class="form-control"/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>


    </div></div>


    <div id="customer-tabs-panel" class="panel panel-default" style="display:none;">
        <div class="panel-body">
            <div>
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">New Customers</a></li>
                    <li role="presentation"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Lost Customers</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="home">
                        <table class="table" id="new-customer-tab" style="width:100%"></table>
                    </div>

                    <div role="tabpanel" class="tab-pane" id="profile">
                        <table class="table" id="lost-customer-tab" style="width:100%"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>




</div>


</body>
</html>